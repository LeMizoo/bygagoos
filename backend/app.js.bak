const express = require('express');
const cors = require('cors');
const jwt = require('jsonwebtoken');

const app = express();

// =========================
// CONFIGURATION
// =========================
const JWT_SECRET = process.env.JWT_SECRET || 'bygagoos-production-secret-2024';
const IS_VERCEL = process.env.VERCEL === '1';

console.log(`Ì∫Ä ByGagoos API starting...`);
console.log(`Ìºç Environment: ${process.env.NODE_ENV || 'development'}`);
console.log(`Ì¥ß Vercel: ${IS_VERCEL ? 'YES' : 'NO'}`);

// =========================
// MIDDLEWARE
// =========================
app.use(cors({
  origin: ['https://bygagoos-ink.vercel.app', 'http://localhost:5173'],
  credentials: true
}));
app.use(express.json());

// =========================
// HEALTH ENDPOINTS
// =========================
app.get('/health', (req, res) => {
  res.json({
    status: 'healthy',
    service: 'ByGagoos API',
    mode: IS_VERCEL ? 'vercel' : 'local',
    timestamp: new Date().toISOString()
  });
});

app.get('/api/health', (req, res) => {
  res.json({
    status: 'API healthy',
    mode: IS_VERCEL ? 'vercel' : 'local'
  });
});

app.get('/', (req, res) => {
  res.json({
    name: 'ByGagoos Ink API',
    version: '1.0.0',
    status: 'operational',
    auth: 'POST /auth/login',
    mode: IS_VERCEL ? 'vercel-production' : 'local-development'
  });
});

// =========================
// AUTHENTICATION - SIMPLE & RELIABLE
// =========================
const users = [
  {
    id: 'admin-001',
    email: 'admin@bygagoos.mg',
    password: 'admin123', // En production, utiliser bcrypt
    name: 'Administrateur ByGagoos',
    role: 'admin'
  },
  {
    id: 'user-001',
    email: 'user@bygagoos.mg',
    password: 'user123',
    name: 'Utilisateur Test',
    role: 'user'
  }
];

const loginHandler = (req, res) => {
  try {
    const { email, password } = req.body;
    
    console.log(`Ì¥ê Login attempt: ${email} (Vercel: ${IS_VERCEL})`);
    
    if (!email || !password) {
      return res.status(400).json({
        success: false,
        message: 'Email et mot de passe requis'
      });
    }
    
    // Trouver l'utilisateur
    const user = users.find(u => u.email === email.trim().toLowerCase());
    
    if (!user) {
      console.log(`‚ùå User not found: ${email}`);
      return res.status(401).json({
        success: false,
        message: 'Identifiants incorrects'
      });
    }
    
    // V√©rifier le mot de passe (en production, utiliser bcrypt)
    if (user.password !== password) {
      console.log(`‚ùå Invalid password for: ${email}`);
      return res.status(401).json({
        success: false,
        message: 'Identifiants incorrects'
      });
    }
    
    // G√©n√©rer le token JWT
    const token = jwt.sign(
      {
        id: user.id,
        email: user.email,
        name: user.name,
        role: user.role
      },
      JWT_SECRET,
      { expiresIn: '7d' }
    );
    
    console.log(`‚úÖ Login successful: ${email}, role: ${user.role}`);
    
    // R√©ponse sans le mot de passe
    const { password: _, ...userWithoutPassword } = user;
    
    res.json({
      success: true,
      token,
      user: userWithoutPassword
    });
    
  } catch (error) {
    console.error('‚ùå Login error:', error);
    res.status(500).json({
      success: false,
      message: 'Erreur serveur',
      error: error.message
    });
  }
};

// =========================
// ROUTES
// =========================
app.post('/auth/login', loginHandler);
app.post('/api/auth/login', loginHandler);

// Route pour v√©rifier le token
app.get('/auth/verify', (req, res) => {
  try {
    const token = req.headers.authorization?.split(' ')[1];
    
    if (!token) {
      return res.status(401).json({
        success: false,
        message: 'Token manquant'
      });
    }
    
    const decoded = jwt.verify(token, JWT_SECRET);
    
    res.json({
      success: true,
      user: decoded
    });
    
  } catch (error) {
    res.status(401).json({
      success: false,
      message: 'Token invalide'
    });
  }
});

// =========================
// 404 HANDLER
// =========================
app.use((req, res) => {
  res.status(404).json({
    error: 'Not Found',
    message: `Route ${req.method} ${req.path} non trouv√©e`,
    availableRoutes: [
      'GET /',
      'GET /health',
      'POST /auth/login',
      'GET /auth/verify'
    ]
  });
});

// =========================
// ERROR HANDLER
// =========================
app.use((err, req, res, next) => {
  console.error('Ì¥• Server error:', err);
  res.status(500).json({
    success: false,
    message: 'Erreur interne du serveur'
  });
});

// =========================
// EXPORT FOR VERCEL
// =========================
module.exports = app;

// Start server if not on Vercel
if (!IS_VERCEL && require.main === module) {
  const PORT = process.env.PORT || 3002;
  app.listen(PORT, () => {
    console.log(`\nÌæâ Server running on http://localhost:${PORT}`);
    console.log(`Ì¥ê Login: POST http://localhost:${PORT}/auth/login`);
    console.log(`Ìø• Health: http://localhost:${PORT}/health`);
  });
}
